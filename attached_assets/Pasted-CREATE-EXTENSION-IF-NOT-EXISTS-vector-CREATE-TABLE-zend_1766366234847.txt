CREATE EXTENSION IF NOT EXISTS "vector";
CREATE TABLE "zendesk_article_embeddings" (
	"id" serial PRIMARY KEY NOT NULL,
	"article_id" integer NOT NULL,
	"content_hash" text NOT NULL,
	"embedding_vector" vector(1536),
	"model_used" text DEFAULT 'text-embedding-3-small' NOT NULL,
	"tokens_used" integer,
	"openai_log_id" integer,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp DEFAULT now() NOT NULL
);
CREATE TABLE "zendesk_articles_statistics" (
	"id" serial PRIMARY KEY NOT NULL,
	"zendesk_article_id" integer NOT NULL,
	"keywords" text,
	"section_id" text,
	"conversation_id" integer,
	"external_conversation_id" text,
	"created_at" timestamp DEFAULT now() NOT NULL
);
CREATE TABLE "zendesk_articles" (
	"id" serial PRIMARY KEY NOT NULL,
	"zendesk_id" text NOT NULL,
	"title" text NOT NULL,
	"body" text,
	"section_id" text,
	"section_name" text,
	"category_id" text,
	"category_name" text,
	"author_id" text,
	"locale" text,
	"html_url" text,
	"draft" boolean DEFAULT false NOT NULL,
	"promoted" boolean DEFAULT false NOT NULL,
	"position" integer,
	"vote_sum" integer,
	"vote_count" integer,
	"label_names" json,
	"zendesk_created_at" timestamp,
	"zendesk_updated_at" timestamp,
	"synced_at" timestamp DEFAULT now() NOT NULL,
	"created_at" timestamp DEFAULT now() NOT NULL,
	"updated_at" timestamp DEFAULT now() NOT NULL,
	"help_center_subdomain" text NOT NULL,
	CONSTRAINT "zendesk_articles_zendesk_id_key" UNIQUE("zendesk_id")
);
DROP INDEX "idx_query_logs_created_at";
DROP INDEX "idx_query_logs_duration";
DROP INDEX "idx_query_stats_avg_duration";
DROP INDEX "idx_query_stats_call_count";
DROP INDEX "idx_external_event_audit_logs_created_at";
DROP INDEX "idx_archive_jobs_archive_date";
DROP INDEX "idx_events_standard_message_aggregation";
ALTER TABLE "zendesk_article_embeddings" ADD CONSTRAINT "zendesk_article_embeddings_article_id_fkey" FOREIGN KEY ("article_id") REFERENCES "public"."zendesk_articles"("id") ON DELETE cascade ON UPDATE no action;
ALTER TABLE "zendesk_article_embeddings" ADD CONSTRAINT "zendesk_article_embeddings_article_id_zendesk_articles_id_fk" FOREIGN KEY ("article_id") REFERENCES "public"."zendesk_articles"("id") ON DELETE cascade ON UPDATE no action;
CREATE UNIQUE INDEX "idx_zendesk_article_embeddings_article_id" ON "zendesk_article_embeddings" USING btree ("article_id");
CREATE INDEX "idx_zendesk_article_embeddings_content_hash" ON "zendesk_article_embeddings" USING btree ("content_hash");
CREATE INDEX "idx_zendesk_article_statistics_article_id" ON "zendesk_articles_statistics" USING btree ("zendesk_article_id");
CREATE INDEX "idx_zendesk_article_statistics_conversation_id" ON "zendesk_articles_statistics" USING btree ("conversation_id");
CREATE INDEX "idx_zendesk_article_statistics_created_at" ON "zendesk_articles_statistics" USING btree ("created_at");
CREATE INDEX "idx_zendesk_articles_statistics_article_id" ON "zendesk_articles_statistics" USING btree ("zendesk_article_id");
CREATE INDEX "idx_zendesk_articles_statistics_conversation_id" ON "zendesk_articles_statistics" USING btree ("conversation_id");
CREATE INDEX "idx_zendesk_articles_statistics_created_at" ON "zendesk_articles_statistics" USING btree ("created_at");
CREATE INDEX "idx_zendesk_articles_help_center_subdomain" ON "zendesk_articles" USING btree ("help_center_subdomain");
CREATE INDEX "idx_zendesk_articles_locale" ON "zendesk_articles" USING btree ("locale");
CREATE INDEX "idx_zendesk_articles_section_id" ON "zendesk_articles" USING btree ("section_id");
CREATE INDEX "idx_zendesk_articles_title" ON "zendesk_articles" USING btree ("title");
CREATE UNIQUE INDEX "idx_zendesk_articles_zendesk_id_subdomain" ON "zendesk_articles" USING btree ("zendesk_id","help_center_subdomain");
CREATE INDEX "idx_conversations_created_at" ON "conversations" USING btree ("created_at");
CREATE INDEX "idx_query_logs_created_at" ON "query_logs" USING btree ("created_at");
CREATE INDEX "idx_query_logs_duration" ON "query_logs" USING btree ("duration_ms");
CREATE INDEX "idx_query_stats_avg_duration" ON "query_stats" USING btree ("avg_duration_ms");
CREATE INDEX "idx_query_stats_call_count" ON "query_stats" USING btree ("call_count");
CREATE INDEX "idx_external_event_audit_logs_created_at" ON "external_event_audit_logs" USING btree ("created_at");
CREATE INDEX "idx_archive_jobs_archive_date" ON "archive_jobs" USING btree ("archive_date");
CREATE INDEX "idx_events_standard_message_aggregation" ON "events_standard" USING btree ("event_type","conversation_id","occurred_at") WHERE (event_type = 'message'::text);